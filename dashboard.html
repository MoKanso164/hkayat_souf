<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - E-Commerce</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="dashboard.html" class="logo">Admin Dashboard</a>
                <div class="header-actions">
                    <span id="user-email" style="color: var(--gray-600); font-size: 0.875rem;"></span>
                    <button id="logout-btn" class="btn btn-secondary btn-sm">Sign Out</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1>Products</h1>
            <button id="add-product-btn" class="btn btn-primary">Add Product</button>
        </div>

        <div id="error-message" class="alert alert-error hidden"></div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 1rem;">Loading products...</p>
        </div>

        <div id="products-container" class="hidden">
            <table class="table">
                <thead class="table-header">
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Colors</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="products-table-body" class="table-body">
                    <!-- Products will be inserted here -->
                </tbody>
            </table>

            <div id="pagination" class="pagination"></div>
        </div>

        <div id="empty-state" class="hidden" style="text-align: center; padding: 3rem;">
            <p style="color: var(--gray-500); margin-bottom: 1rem;">No products yet</p>
            <button id="add-first-product-btn" class="btn btn-primary">Create Your First Product</button>
        </div>
    </main>

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Add Product</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    
                    <div class="form-group">
                        <label for="product-name" class="form-label required">Name</label>
                        <input type="text" id="product-name" class="form-input" required aria-required="true">
                    </div>

                    <div class="form-group">
                        <label for="product-details" class="form-label">Details</label>
                        <textarea id="product-details" class="form-textarea" rows="4"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="product-price" class="form-label required">Price ($)</label>
                        <input type="number" id="product-price" class="form-input" step="0.01" min="0" required aria-required="true">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Colors</label>
                        <div id="colors-container"></div>
                        <div class="color-input-group">
                            <input type="color" id="color-picker" class="color-input" value="#000000">
                            <input type="text" id="color-text" class="form-input color-text-input" placeholder="#000000" pattern="^#[0-9A-Fa-f]{6}$">
                            <button type="button" id="add-color-btn" class="btn btn-secondary">Add Color</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="product-image" class="form-label">Image</label>
                        <input type="file" id="products" class="form-input" accept="image/jpeg,image/jpg,image/png,image/webp">
                        <div id="image-preview-container" class="image-preview-container hidden">
                            <img id="image-preview" class="image-preview" alt="Preview">
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="product-is-public" style="width: auto;">
                            <span>Make product public (visible in storefront)</span>
                        </label>
                    </div>

                    <div id="form-error" class="form-error hidden"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
                <button type="submit" form="product-form" class="btn btn-primary" id="save-btn">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Delete Product</h2>
                <button class="modal-close" id="delete-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-delete-btn">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>

    <script src="./config.js"></script>
    <script type="module">
        import { initSupabase } from './config.js';
        import { isAdmin, signOut, getCurrentUser } from './auth.js';
        import { getAllProducts, createProduct, updateProduct, deleteProduct } from './products.js';
        import { uploadImage, createImagePreview, revokeImagePreview, validateImageFile } from './storage.js';
        import { showToast, formatPrice } from './utils.js';

        // Initialize
        await initSupabase();

        // Check authentication and admin role
        const user = await getCurrentUser();
        if (!user) {
            window.location.href = 'login.html';
            throw new Error('Not authenticated');
        }

        const admin = await isAdmin();
        if (!admin) {
            alert('Access denied. Admin privileges required.');
            window.location.href = 'login.html';
            throw new Error('Not admin');
        }

        // Set user email
        document.getElementById('user-email').textContent = user.email;

        // State
        let currentPage = 1;
        let products = [];
        let productToDelete = null;
        let imagePreviewUrl = null;

        // DOM Elements
        const loadingEl = document.getElementById('loading');
        const productsContainer = document.getElementById('products-container');
        const emptyState = document.getElementById('empty-state');
        const productsTableBody = document.getElementById('products-table-body');
        const paginationEl = document.getElementById('pagination');
        const productModal = document.getElementById('product-modal');
        const deleteModal = document.getElementById('delete-modal');
        const productForm = document.getElementById('product-form');
        const colorsContainer = document.getElementById('colors-container');
        const colorPicker = document.getElementById('color-picker');
        const colorText = document.getElementById('color-text');
        const addColorBtn = document.getElementById('add-color-btn');
        const productImage = document.getElementById('product-image');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');

        // Load products
        async function loadProducts() {
            loadingEl.classList.remove('hidden');
            productsContainer.classList.add('hidden');
            emptyState.classList.add('hidden');

            try {
                const { data, error, count } = await getAllProducts({ page: currentPage, pageSize: 20 });
                
                if (error) throw error;

                products = data || [];
                renderProducts();
                renderPagination(count || 0);

                if (products.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    productsContainer.classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('error-message').textContent = 'Failed to load products: ' + error.message;
                document.getElementById('error-message').classList.remove('hidden');
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // Render products table
        function renderProducts() {
            productsTableBody.innerHTML = products.map(product => `
                <tr>
                    <td>
                        ${product.image_url 
                            ? `<img src="${product.image_url}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 0.25rem;">`
                            : '<div style="width: 50px; height: 50px; background: var(--gray-200); border-radius: 0.25rem;"></div>'
                        }
                    </td>
                    <td><strong>${escapeHtml(product.name)}</strong></td>
                    <td>${formatPrice(product.price)}</td>
                    <td>
                        <div class="color-swatches">
                            ${(product.colors || []).map(color => 
                                `<div class="color-swatch" style="background-color: ${color};" title="${color}"></div>`
                            ).join('')}
                        </div>
                    </td>
                    <td>
                        <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; ${product.is_public ? 'background: #d1fae5; color: #065f46;' : 'background: #fee2e2; color: #991b1b;'}">
                            ${product.is_public ? 'Public' : 'Draft'}
                        </span>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editProduct('${product.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDelete('${product.id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Render pagination
        function renderPagination(total) {
            const totalPages = Math.ceil(total / 20);
            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            paginationEl.innerHTML = `
                <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Previous</button>
                <span class="pagination-info">Page ${currentPage} of ${totalPages}</span>
                <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>
            `;
        }

        // Global functions for onclick handlers
        window.goToPage = (page) => {
            currentPage = page;
            loadProducts();
        };

        window.editProduct = async (id) => {
            const product = products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-details').value = product.details || '';
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-is-public').checked = product.is_public;

            // Set colors
            colorsContainer.innerHTML = '';
            (product.colors || []).forEach(color => {
                addColorSwatch(color);
            });

            // Set image preview
            if (product.image_url) {
                imagePreview.src = product.image_url;
                imagePreviewContainer.classList.remove('hidden');
            } else {
                imagePreviewContainer.classList.add('hidden');
            }

            document.getElementById('modal-title').textContent = 'Edit Product';
            productModal.classList.add('active');
        };

        window.confirmDelete = (id) => {
            productToDelete = id;
            deleteModal.classList.add('active');
        };

        // Add product button
        document.getElementById('add-product-btn').addEventListener('click', () => {
            productForm.reset();
            document.getElementById('product-id').value = '';
            colorsContainer.innerHTML = '';
            imagePreviewContainer.classList.add('hidden');
            imagePreviewUrl = null;
            document.getElementById('modal-title').textContent = 'Add Product';
            productModal.classList.add('active');
        });

        document.getElementById('add-first-product-btn').addEventListener('click', () => {
            document.getElementById('add-product-btn').click();
        });

        // Color management
        colorPicker.addEventListener('input', (e) => {
            colorText.value = e.target.value.toUpperCase();
        });

        colorText.addEventListener('input', (e) => {
            const value = e.target.value;
            if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                colorPicker.value = value;
            }
        });

        addColorBtn.addEventListener('click', () => {
            const color = colorText.value || colorPicker.value;
            if (!/^#[0-9A-Fa-f]{6}$/.test(color)) {
                showToast('Please enter a valid hex color (e.g., #FF0000)', 'error');
                return;
            }
            addColorSwatch(color.toUpperCase());
            colorText.value = '';
            colorPicker.value = '#000000';
        });

        function addColorSwatch(color) {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch';
            swatch.style.backgroundColor = color;
            swatch.title = color;
            swatch.innerHTML = `<button type="button" onclick="this.parentElement.remove()" style="position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; cursor: pointer; display: none;">Ã—</button>`;
            swatch.style.position = 'relative';
            swatch.addEventListener('mouseenter', () => {
                swatch.querySelector('button').style.display = 'block';
            });
            swatch.addEventListener('mouseleave', () => {
                swatch.querySelector('button').style.display = 'none';
            });
            colorsContainer.appendChild(swatch);
        }

        // Image preview
        productImage.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                imagePreviewContainer.classList.add('hidden');
                if (imagePreviewUrl) {
                    revokeImagePreview(imagePreviewUrl);
                    imagePreviewUrl = null;
                }
                return;
            }

            const validation = validateImageFile(file);
            if (!validation.valid) {
                showToast(validation.error, 'error');
                e.target.value = '';
                return;
            }

            imagePreviewUrl = createImagePreview(file);
            imagePreview.src = imagePreviewUrl;
            imagePreviewContainer.classList.remove('hidden');
        });

        // Product form submission
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const productId = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const details = document.getElementById('product-details').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const isPublic = document.getElementById('product-is-public').checked;

            // Get colors
            const colors = Array.from(colorsContainer.querySelectorAll('.color-swatch'))
                .map(swatch => swatch.style.backgroundColor);

            // Validate
            if (!name.trim()) {
                showToast('Product name is required', 'error');
                return;
            }

            if (price < 0) {
                showToast('Price must be positive', 'error');
                return;
            }

            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                let imageUrl = null;

                // Upload image if new file selected
               // Upload image if new file selected
if (productImage.files[0]) {
    const { data, error } = await uploadImage(productImage.files[0], productId || undefined);
    if (error) {
        // Show the real error message from Supabase instead of [object Object]
        throw new Error('Failed to upload image: ' + (error.message || JSON.stringify(error)));
    }
    imageUrl = data.url;


                } else if (productId) {
                    // Keep existing image if editing and no new file
                    const existingProduct = products.find(p => p.id === productId);
                    imageUrl = existingProduct?.image_url || null;
                }

                const productData = {
                    name: name.trim(),
                    details: details.trim() || null,
                    price,
                    colors,
                    image_url: imageUrl,
                    is_public: isPublic,
                };

                let result;
                if (productId) {
                    result = await updateProduct(productId, productData);
                } else {
                    result = await createProduct(productData);
                }

                if (result.error) {
                    throw result.error;
                }

                showToast(`Product ${productId ? 'updated' : 'created'} successfully!`, 'success');
                productModal.classList.remove('active');
                productForm.reset();
                colorsContainer.innerHTML = '';
                imagePreviewContainer.classList.add('hidden');
                if (imagePreviewUrl) {
                    revokeImagePreview(imagePreviewUrl);
                    imagePreviewUrl = null;
                }
                loadProducts();
            } catch (error) {
                showToast('Failed to save product: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Product';
            }
        });

        // Modal controls
        document.getElementById('modal-close').addEventListener('click', () => {
            productModal.classList.remove('active');
        });

        document.getElementById('cancel-btn').addEventListener('click', () => {
            productModal.classList.remove('active');
        });

        // Delete modal
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if (!productToDelete) return;

            const deleteBtn = document.getElementById('confirm-delete-btn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';

            try {
                const { error } = await deleteProduct(productToDelete);
                if (error) throw error;

                showToast('Product deleted successfully', 'success');
                deleteModal.classList.remove('active');
                productToDelete = null;
                loadProducts();
            } catch (error) {
                showToast('Failed to delete product: ' + error.message, 'error');
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Delete';
            }
        });

        document.getElementById('delete-modal-close').addEventListener('click', () => {
            deleteModal.classList.remove('active');
            productToDelete = null;
        });

        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            deleteModal.classList.remove('active');
            productToDelete = null;
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await signOut();
            window.location.href = 'login.html';
        });

        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initial load
        loadProducts();
    </script>
</body>
</html>



